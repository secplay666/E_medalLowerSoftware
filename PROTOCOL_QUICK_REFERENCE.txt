═══════════════════════════════════════════════════════════════
  可靠图像传输协议 V2 - 快速参考卡
═══════════════════════════════════════════════════════════════

【通信流程】

1️⃣  上位机 → 单片机: START (0x01)
    单片机 ← 上位机: READY (0x03)  ← 等待5秒

2️⃣  上位机 → 单片机: IMAGE_HEADER (0x11, 259字节)
    单片机 ← 上位机: ACK/NAK (0x20/0x21)  ← 等待3秒，重试最多5次

3️⃣  上位机 → 单片机: IMAGE_DATA[0..60] (0x10, 259字节)
    单片机 ← 上位机: ACK/NAK × 61  ← 每帧等待3秒，重试最多5次

4️⃣  上位机 → 单片机: END (0x02)
    单片机 ← 上位机: COMPLETE/FAIL (0x04/0x05)  ← 等待5秒

═══════════════════════════════════════════════════════════════

【帧格式速查】

控制帧 (4字节)：START / END / READY / COMPLETE / FAIL
├─ [0] 0x55 (帧头)
├─ [1] 命令码 (0x01/0x02/0x03/0x04/0x05)
├─ [2] 校验和 = (byte[0] + byte[1]) & 0xFF
└─ [3] 0xAA (帧尾)

应答帧 (6字节)：ACK / NAK
├─ [0] 0x55 (帧头)
├─ [1] 响应码 (0x20=ACK, 0x21=NAK)
├─ [2] 帧号低字节
├─ [3] 帧号高字节
├─ [4] 校验和 = (byte[0]+byte[1]+byte[2]+byte[3]) & 0xFF
└─ [5] 0xAA (帧尾)

数据帧 (259字节)：IMAGE_HEADER / IMAGE_DATA
├─ [0] 0x55 (帧头)
├─ [1] 类型 (0x11=HEADER, 0x10=DATA)
├─ [2-3] 帧号 (LE, 仅DATA使用，HEADER固定为0)
├─ [4] Slot ID (0-7)
├─ [5-8] CRC32 (LE) - 对[9-256]计算
├─ [9-256] 负载 (248字节)
├─ [257] 校验和 = sum([0-256]) & 0xFF
└─ [258] 0xAA (帧尾)

═══════════════════════════════════════════════════════════════

【命令码速查表】

0x01 = START      (上位机发) 开始传输
0x02 = END        (上位机发) 结束传输
0x03 = READY      (单片机发) 准备好接收
0x04 = COMPLETE   (单片机发) 验证成功
0x05 = FAIL       (单片机发) 验证失败
0x10 = IMAGE_DATA (上位机发) 图像数据帧
0x11 = IMAGE_HEADER (上位机发) 图像头帧
0x20 = ACK        (单片机发) 接收成功
0x21 = NAK        (单片机发) 接收失败

═══════════════════════════════════════════════════════════════

【关键参数】

帧类型                    帧长    响应      超时    重试
─────────────────────────────────────────────────────────
START/END/READY/COMPLETE  4字节  无/READY   5秒    N/A
IMAGE_HEADER              259字节 ACK/NAK   3秒    5次
IMAGE_DATA[0..60]         259字节 ACK/NAK   3秒    5次×61

图像数据：61帧 × 248字节/帧 = 15,088字节
最坏传输量：61帧 × 259字节 × 5重试 = 79,435字节
预期传输量：(1+61) × 259字节 = 16,058字节 (含头)

═══════════════════════════════════════════════════════════════

【调试技巧】

上位机日志：
✅ 帧N已确认 (ACK)      = 帧N接收成功
❌ 帧N需要重传 (NAK)    = 帧N失败，将重试
🔵 单片机已准备好接收   = 收到READY响应
✅ 单片机验证成功       = 收到COMPLETE
❌ 单片机检验失败       = 收到FAIL (缺失帧)

单片机日志：
[IMG_V2] RX CTRL: START    = 收到开始命令
[IMG_V2] TX CTRL: READY    = 准备好接收
[IMG_V2] RX DATA: frame=N  = 收到第N帧
[IMG_V2] Frame N saved     = 第N帧已存储
[IMG_V2] TX ACK: frame=N   = 发送ACK
[IMG_V2] TX NAK: frame=N   = 发送NAK
[IMG_V2] COMPLETE          = 验证成功
[IMG_V2] FAILED            = 验证失败

═══════════════════════════════════════════════════════════════

【故障排除】

问题：上位机卡在"等待READY"
└─ 检查单片机是否收到START
└─ 检查串口波特率和连接
└─ 查看单片机日志中是否有"RX CTRL: START"

问题：某一帧重试5次仍失败
└─ 检查CRC32计算是否正确
└─ 检查Frame buffer是否越界
└─ 尝试降低传输速度（增加帧间延迟）

问题：传输完成但返回FAIL
└─ 检查是否所有61帧都收到ACK
└─ 检查位图(bitmap)中是否有缺失帧
└─ 查看单片机日志中缺失的帧号

问题：单片机Flash写入失败
└─ 检查Flash初始化是否成功
└─ 检查Slot ID是否有效 (0-7)
└─ 检查Flash是否已满

═══════════════════════════════════════════════════════════════

【协议状态机】

上位机状态：
IDLE → SEND_START → WAIT_READY → SEND_HEADER → WAIT_ACK_HEADER
     → SEND_DATA → WAIT_ACK_DATA (×61)
     → SEND_END → WAIT_COMPLETE/FAIL → DONE

单片机状态：
IDLE → RX_START → READY → RX_HEADER → RX_DATA
     → RX_END → VERIFY → SEND_COMPLETE/FAIL → COMPLETE

═══════════════════════════════════════════════════════════════

【最后核对清单】

□ 上位机正确解析ACK/NAK响应
□ 上位机每帧等待3秒ACK/NAK
□ 上位机NAK时自动重试，最多5次
□ 单片机收到数据后立即验证
□ 单片机验证成功后立即写Flash
□ 单片机Flash写入后立即发送ACK
□ 单片机收到END后验证所有61帧
□ 单片机缺失帧时返回FAIL
□ 帧位图(bitmap)正确跟踪已接收帧
□ 协议帧校验和正确计算
□ CRC32计算与两端一致

═══════════════════════════════════════════════════════════════
