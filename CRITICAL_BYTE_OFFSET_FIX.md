# ğŸ”´ ä¸¥é‡Bugä¿®å¤ï¼šå¸§å­—èŠ‚ä½ç½®é”™è¯¯

## é—®é¢˜ç—‡çŠ¶

```
[IMG_DBG] IDLE: Received 1 new bytes, total=1, rx_idx=1
[IMG_DBG] IDLE: Received 1 new bytes, total=2, rx_idx=2
...
[IMG_DBG] IDLE: Received 1 new bytes, total=4, rx_idx=4
[IMG_DBG] RX_BUF in IDLE: 5A 5A 5A 5A        â† å¸§å°¾è¢«é‡å¤æ‰“å°ï¼
[IMG_DBG] RX_BUF in IDLE: 5A 5A 5A 5A        â† è¿™è¯´æ˜ç¼“å†²æ··ä¹±
```

**ç°è±¡**: æ¥æ”¶åˆ°çš„å…¨æ˜¯å¸§å°¾å­—èŠ‚ `0x5A5A5A5A`ï¼Œæ— æ³•è¯†åˆ«å¸§å¤´

---

## ğŸ¯ æ ¹æœ¬åŸå› 

**å¸§ç»“æ„å®šä¹‰ä¸åŒ¹é…ï¼**

### æ­£ç¡®çš„å¸§æ ¼å¼ï¼ˆä¸Šä½æœºå‘é€ï¼‰

```
å­—èŠ‚èŒƒå›´     å†…å®¹          å­—èŠ‚æ•°      å…·ä½“å€¼
0-3         å¸§å¤´          4          0xA5 0xA5 0xA5 0xA5
4           slot_id       1          0x00-0x07
5           magic/type    1          0xA3æˆ–0xA4
6           frame_id      1          0x00-0x3C
7           reserved      1          0x00
8-11        CRC32         4          æ ¡éªŒå€¼ï¼ˆå¤§ç«¯åºï¼‰
12-259      payload       248        å›¾åƒæ•°æ®
260-263     å¸§å°¾          4          0x5A 0x5A 0x5A 0x5A
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡                       264 bytes
```

### ä»£ç ä¸­çš„é”™è¯¯è¯»å–ï¼ˆä¿®æ”¹å‰ï¼‰

```c
// åŸé”™è¯¯ä»£ç  (image_transfer.c:442-446)
lastImageMagic = rx_buf[4];   // âŒ è¯»çš„æ˜¯slot_id
lastSlotId = rx_buf[5];       // âŒ è¯»çš„æ˜¯magic
lastFrameNum = rx_buf[6];     // âœ“ è¯»çš„æ˜¯frame_idï¼ˆæ­£ç¡®ä½†å˜é‡åè¯­ä¹‰é”™ï¼‰
```

**é—®é¢˜é“¾**:
1. è¯»é”™å­—èŠ‚ â†’ å€¼ä¸åŒ¹é…
2. æ ¡éªŒé€»è¾‘: `if (lastImageMagic != MAGIC_BW_IMAGE_DATA && ...)`
3. `lastImageMagic` å®é™…å€¼ = `slot_id`ï¼ˆ0x00ï¼‰ï¼Œä¸ç­‰äº 0xA3/0xA4
4. è§¦å‘"Invalid magic"é”™è¯¯
5. ç¼“å†²åŒºä¸è¢«æ¸…ç©ºï¼Œç»§ç»­ç§¯ç´¯æ•°æ®
6. æœ€ç»ˆå¯¼è‡´æ¥æ”¶åˆ°å¸§å°¾æ—¶ç¼“å†²æº¢å‡º

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹ä½ç½®ï¼šimage_transfer.c ç¬¬442-446è¡Œ

```diff
- lastImageMagic = rx_buf[4];
- lastSlotId = rx_buf[5];
- lastFrameNum = rx_buf[6];
+ lastSlotId = rx_buf[4];
+ lastImageMagic = rx_buf[5];
+ lastFrameNum = rx_buf[6];
```

### ä¿®æ”¹åçš„æ­£ç¡®ä»£ç 

```c
// è§£ææ¥æ”¶åˆ°çš„å¸§æ•°æ®
// å¸§æ ¼å¼: [å¸§å¤´4] [slot_id1] [magic1] [frame_id1] [reserved1] [crc32_4] [payload248] [å¸§å°¾4]
//         0-3      4          5         6           7           8-11      12-259      260-263
lastSlotId = rx_buf[4];        // å­—èŠ‚4 = slot_id âœ“
lastImageMagic = rx_buf[5];    // å­—èŠ‚5 = magic/type âœ“
lastFrameNum = rx_buf[6];      // å­—èŠ‚6 = frame_id/pageIdx âœ“
// rx_buf[7];                  // å­—èŠ‚7 = reserved
crcReceived = (rx_buf[8]<<24)|(rx_buf[9]<<16)|(rx_buf[10]<<8)|rx_buf[11];
data = &rx_buf[12];
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœéªŒè¯

### ä¿®æ”¹å‰çš„æ‰§è¡Œæµ

```
æ¥æ”¶ 264 å­—èŠ‚å¸§
  â†“
å¸§å°¾æ£€æŸ¥ âœ“ (æ­£ç¡®)
  â†“
è¯»å–å¸§æ•°æ® âŒ (ä½ç½®å…¨é”™)
  lastImageMagic = 0x00 (slot_idçš„å€¼)
  lastSlotId = 0xA3 (magicçš„å€¼)
  lastFrameNum = 0x00 (frame_idçš„å€¼)
  â†“
Magicæ ¡éªŒ âŒ (0x00 != 0xA3)
  â†“
å‘é€é”™è¯¯ï¼Œä¸æ¸…ç©ºç¼“å†²
  â†“
ä¸‹ä¸€æ¬¡æ¥æ”¶æ—¶ç¼“å†²æ··ä¹±
  â†“
æ˜¾ç¤º 5A 5A 5A 5Aï¼ˆå¸§å°¾ï¼‰æ··ä¹±
```

### ä¿®æ”¹åçš„æ‰§è¡Œæµ

```
æ¥æ”¶ 264 å­—èŠ‚å¸§
  â†“
å¸§å°¾æ£€æŸ¥ âœ“ (æ­£ç¡®)
  â†“
è¯»å–å¸§æ•°æ® âœ“ (ä½ç½®æ­£ç¡®)
  lastSlotId = 0x00 âœ“
  lastImageMagic = 0xA3 âœ“
  lastFrameNum = 0x00 âœ“
  â†“
Magicæ ¡éªŒ âœ“ (0xA3 == 0xA3)
  â†“
CRCæ ¡éªŒ âœ“
  â†“
æ•°æ®å†™å…¥Flash âœ“
  â†“
æ¸…ç©ºç¼“å†²ï¼Œå‡†å¤‡ä¸‹ä¸€å¸§ âœ“
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. **åº”ç”¨ä¿®å¤**:
   - image_transfer.cç¬¬442-446è¡Œå·²ä¿®æ”¹

2. **é‡æ–°ç¼–è¯‘**:
   ```
   Project â†’ Build Target (F7)
   ç¡®ä¿æ— ç¼–è¯‘é”™è¯¯
   ```

3. **ä¸Šä¼ å›ºä»¶**:
   - çƒ§å†™æ–°å›ºä»¶åˆ°è®¾å¤‡

4. **å‘é€å›¾åƒ**:
   - æ‰“å¼€ä¸Šä½æœºå·¥å…·
   - å‘é€ä¸€å¼ å›¾åƒ

5. **è§‚å¯Ÿæ—¥å¿—**:

   **âœ“ æˆåŠŸæ ‡å¿—**ï¼ˆä¿®å¤æœ‰æ•ˆï¼‰:
   ```
   [IMG_DBG] IDLE: Received 4 new bytes, total=4, rx_idx=4
   [IMG_DBG] Frame 1: Header pos=0, rx_idx=4
   [IMG_DBG] IDLE: Received 1 new bytes, total=5, rx_idx=5
   [IMG_DBG] Parse: magic=0xA3, slot=0, frame=0
   [IMG_DBG] CRC: rx=0x..., calc=0x...
   [IMG_DBG] Frame 0 saved, frameIsFull=0x0000000000000001
   ```

   **âœ— å¤±è´¥æ ‡å¿—**ï¼ˆä¿®å¤æœªç”Ÿæ•ˆï¼‰:
   ```
   [IMG_DBG] RX_BUF in IDLE: 5A 5A 5A 5A
   [IMG_DBG] ERROR: Invalid magic  æˆ–ç±»ä¼¼é”™è¯¯
   ```

---

## ğŸ’¡ ä¸ºä»€ä¹ˆè¿™ä¸ªbugè¿™ä¹ˆä¸¥é‡

1. **å­—èŠ‚ä½ç½®é”™è¯¯ â†’ æ•°æ®æ ¡éªŒå¤±è´¥**
   - Magicå€¼ä¸åŒ¹é…
   - è§¦å‘éªŒè¯å¤±è´¥

2. **éªŒè¯å¤±è´¥ â†’ ç¼“å†²ä¸æ¸…ç©º**
   - é”™è¯¯çš„æ•°æ®ç•™åœ¨ç¼“å†²åŒº
   - åç»­æ•°æ®æ— æ³•æ­£ç¡®å¤„ç†

3. **ç¼“å†²æ··ä¹± â†’ é‡å¤çœ‹åˆ°å¸§å°¾**
   - ç¼“å†²ä¸­ç§¯ç´¯äº†æ··ä¹±æ•°æ®
   - å¸§å°¾ 0x5A5A5A5A è¢«åå¤æ‰“å°

4. **æ¶æ€§å¾ªç¯ â†’ ä¼ è¾“å®Œå…¨å¤±è´¥**
   - æ¯ä¸€å¸§éƒ½å¤±è´¥
   - æ— æ³•å»ºç«‹æ­£ç¡®çš„é€šä¿¡

---

## ğŸ“ ä¿®æ”¹éªŒè¯æ¸…å•

- [x] ä¿®æ”¹äº† `lastImageMagic = rx_buf[5]` ï¼ˆä»rx_buf[4]æ”¹ä¸º[5]ï¼‰
- [x] ä¿®æ”¹äº† `lastSlotId = rx_buf[4]` ï¼ˆä»rx_buf[5]æ”¹ä¸º[4]ï¼‰
- [x] ä¿æŒ `lastFrameNum = rx_buf[6]` ï¼ˆå·²æ­£ç¡®ï¼‰
- [x] æ·»åŠ äº†å¸§æ ¼å¼æ³¨é‡Šï¼Œè¯´æ˜æ¯ä¸ªå­—èŠ‚ä½ç½®
- [x] é‡æ–°ç¼–è¯‘é¡¹ç›®ï¼ˆç¡®ä¿æ— é”™è¯¯ï¼‰

---

## ğŸ“ å…³é”®å­¦ä¹ ç‚¹

**é—®é¢˜çš„æ ¹æº**:
- æ•°æ®ç»“æ„å®šä¹‰ä¸æ¥æ”¶è§£æä¸ä¸€è‡´
- å­—èŠ‚é¡ºåºå’Œä½ç½®å¿…é¡»ç²¾ç¡®åŒ¹é…

**è§£å†³æ–¹æ³•**:
- ä»”ç»†å¯¹æ¯”ä¸Šä½æœºå‘é€æ ¼å¼å’Œä¸‹ä½æœºæ¥æ”¶æ ¼å¼
- ä½¿ç”¨æ˜ç¡®çš„æ³¨é‡Šæ ‡æ³¨æ¯ä¸ªå­—èŠ‚ä½ç½®
- æ·»åŠ è°ƒè¯•è¾“å‡ºéªŒè¯

**é¢„é˜²æªæ–½**:
- åœ¨åˆæœŸå°±åº”è¯¥æ‰“å°å‡ºæ¥æ”¶åˆ°çš„åŸå§‹å­—èŠ‚
- ä¸ä¸Šä½æœºå‘é€çš„å†…å®¹å¯¹æ¯”
- å»ºç«‹è‡ªåŠ¨åŒ–çš„å¸§æ ¼å¼éªŒè¯

---

## ğŸš€ ç°åœ¨ç«‹å³æµ‹è¯•

ä¿®æ”¹å·²åº”ç”¨åˆ°ä»£ç ä¸­ã€‚è¯·ï¼š

1. é‡æ–°ç¼–è¯‘
2. ä¸Šä¼ æ–°å›ºä»¶
3. å‘é€æµ‹è¯•å›¾åƒ
4. è§‚å¯Ÿæ˜¯å¦çœ‹åˆ° `Frame 0 saved` æ¶ˆæ¯

**é¢„æœŸ**: è¿™æ¬¡åº”è¯¥èƒ½æˆåŠŸæ¥æ”¶å’Œå­˜å‚¨å›¾åƒï¼

