# 图像传输协议 V2 - 调试指南

## 问题描述

上位机显示错误：
```
[00:44:21] ℹ️ 📤 发送START命令
[00:44:26] ❌ ❌ 传输失败: 控制帧超时 (5000ms)
```

**原因**：单片机没有收到上位机发送的START命令，或者UART通信有问题

## 调试步骤

### 步骤1：验证UART连接和初始化

编译并烧写新的固件后，打开串口，应该看到以下初始化信息：

```
Done!
Chip id is 0xef4017 !
flash_manager init completely!
image_transfer init completely!
[IMG_V2] Protocol V2 initialized
[IMG_V2] MAX_RETRIES=5, IMAGE_PAGES=61
[IMG_V2] FRAME_PAYLOAD_SIZE=248, TIMEOUT_FRAME=3000ms

═══════════════════════════════════════════════════════════════
   图像传输协议 V2 - 调试模式已启动
═══════════════════════════════════════════════════════════════
[DEBUG] 单片机已就绪，等待上位机START命令...
[DEBUG] UART波特率: 9600 baud
[DEBUG] Flash Manager: OK
[DEBUG] 如果没有看到START命令，请检查:
  1. 上位机和单片机的UART连接
  2. 波特率设置是否一致
  3. 上位机是否正确发送了START
═══════════════════════════════════════════════════════════════
```

**✅ 如果看到上述信息**: UART初始化成功，继续步骤2

**❌ 如果看不到上述信息**:
- 检查串口线是否连接正确
- 检查波特率设置 (应该是 9600)
- 检查单片机是否正确烧写固件

### 步骤2：检查上位机发送

在上位机点击"开始传输"后，单片机应该显示接收到的数据。

#### 预期的调试输出

```
[IMG_V2] 📥 RX 4 bytes: 55 01 56 AA [state=0]
[IMG_V2_DEBUG] CTRL frame check: cmd=0x01, checksum=56 (expected=56)
[IMG_V2] ✅ RX CTRL: cmd=0x01
[IMG_V2] Transfer started, waiting for header...
[IMG_V2] TX CTRL: READY (0x03)
```

#### 如果看不到RX信息

**问题**: 单片机没有接收到任何数据

**可能的原因**：
1. **波特率不匹配** - 上位机和单片机波特率设置不同
   - 上位机：检查"波特率"下拉框是否选择 115200
   - 单片机：代码中是 9600
   - ⚠️ **这两个波特率不匹配！**

2. **UART线连接错误**
   - 检查RX/TX是否正确连接（注意方向）
   - 检查GND是否连接

3. **上位机没有正确发送**
   - 检查上位机日志是否显示"发送START"
   - 如果日志显示发送但单片机未收到，检查UART线

### 步骤3：波特率问题诊断

**发现的问题**：
```
上位机默认波特率: 115200
单片机波特率: 9600
比例: 115200 / 9600 = 12
```

这意味着上位机每发送的数据，单片机会错误地接收12倍的垃圾数据。

#### 解决方案A：改上位机波特率为9600

在上位机工具中：
1. 点击"串口设置"
2. 将波特率改为 **9600**
3. 重新连接
4. 再试一次传输

#### 解决方案B：改单片机波特率为115200

在 `source/uart_interface.c` 中找到波特率设置，改为115200。

**推荐**: 使用解决方案A（改上位机），因为改动更少。

### 步骤4：验证START命令接收

如果波特率修改后，单片机显示：
```
[IMG_V2] 📥 RX 4 bytes: 55 01 56 AA [state=0]
```

这表示：
- ✅ 接收到4字节控制帧
- ✅ 帧头 (0x55) 正确
- ✅ 命令 (0x01 = START) 正确
- ✅ 帧尾和校验和正确

继续看下一行应该显示：
```
[IMG_V2] Transfer started, waiting for header...
[IMG_V2] TX CTRL: READY (0x03)
```

这表示单片机已发送READY响应。

### 步骤5：验证上位机收到READY

上位机日志应该显示：
```
🔵 单片机已准备好接收
```

如果看到这条信息，说明通信已建立！继续观察后续的帧传输。

## 调试信息解读

### 控制帧接收

```
[IMG_V2] 📥 RX 4 bytes: 55 01 56 AA [state=0]
```
- 📥: 表示接收到数据
- RX 4 bytes: 接收4字节
- 55 01 56 AA: 帧的16进制内容
  - 55: 帧头 (START_MARK)
  - 01: 命令码 (CMD_START)
  - 56: 校验和
  - AA: 帧尾 (STOP_MARK)
- [state=0]: 当前状态 (0=IDLE)

### 数据帧接收

```
[IMG_V2] 📥 RX 259 bytes: 55 10 00 00 00 ... AA [state=2]
```
- 259 bytes: 完整的数据帧
- 55: 帧头
- 10: 帧类型 (IMAGE_DATA)
- 00 00: 帧编号 (0)
- ...
- AA: 帧尾
- [state=2]: 状态 (2=WAITING_DATA)

### 应答帧发送

```
[IMG_V2] TX ACK: frame=0
```
- TX: 发送
- ACK: 应答成功
- frame=0: 帧0

## 常见问题

### Q1: 波特率不匹配如何修改？

**A**: 改上位机波特率（更简单）

1. 打开 `tools/串口调试助手_V3_升级版.html`
2. 找到波特率下拉框 (通常在连接设置区)
3. 改为 **9600** (或改单片机为115200)

### Q2: 如何确认波特率问题？

**A**: 观察接收到的数据模式

正确的波特率：
```
[IMG_V2] 📥 RX 4 bytes: 55 01 56 AA
[IMG_V2_DEBUG] CTRL frame check: cmd=0x01, checksum=56
```

错误的波特率（可能显示垃圾数据）：
```
[IMG_V2] 📥 RX 12 bytes: FE FF FE FF ... (看起来乱码)
[IMG_V2_DEBUG] CTRL frame incomplete: idx=4/4
```

### Q3: 如何判断UART线是否接触良好？

**A**: 查看数据是否规律地接收

- 如果能接收数据（即使不对）→ 线路连接可能OK，但波特率可能错
- 如果完全收不到数据 → 检查UART线连接

### Q4: 单片机发送的READY上位机收不到怎么办？

**A**: 检查是否是双向通信问题

1. 确认RX和TX没有接反
2. 检查波特率是否一致
3. 试试断开重连

## 快速诊断流程图

```
开始传输
    ↓
单片机收到数据吗？
    ├─ 否 → 检查波特率 (9600)
    │      检查UART线连接
    │      检查固件烧写
    │
    └─ 是 → 数据是否正确 (55 01 56 AA)?
           ├─ 否 → 波特率错误，改为9600
           │
           └─ 是 → 单片机是否发送了READY?
                  ├─ 否 → 检查send_ctrl_frame函数
                  │
                  └─ 是 → 上位机收到READY吗?
                         ├─ 否 → 检查上位机接收逻辑
                         │
                         └─ 是 → 继续传输！
```

## 调试命令（可选）

如果需要从上位机主动发送测试数据，可以在"数据发送"框中输入：

| 命令 | HEX值 | 说明 |
|------|-------|------|
| START | 55 01 56 AA | 开始传输 |
| END | 55 02 57 AA | 结束传输 |
| READY | 55 03 58 AA | 单片机准备 |
| ACK Frame 0 | 55 20 00 00 75 AA | 应答帧0 |

## 更多调试技巧

### 1. 启用16进制显示模式

在接收数据框的"显示模式"改为"16进制 (HEX)"，可以更清楚地看到原始数据。

### 2. 查看完整日志

在"调试日志"框中可以看到所有详细的处理过程。

### 3. 保存接收数据

点击"下载"按钮可以保存接收到的所有数据，便于离线分析。

## 最后步骤

1. ✅ 确认波特率为 9600
2. ✅ 确认UART线连接正确
3. ✅ 看到初始化信息说明单片机就绪
4. ✅ 看到RX信息说明通信建立
5. ✅ 看到READY说明握手成功
6. ✅ 开始传输图像数据

## 常用的调试信息清单

| 信息 | 含义 |
|------|------|
| `[IMG_V2] 📥 RX` | 成功接收数据 |
| `[IMG_V2] ✅ RX CTRL` | 成功解析控制帧 |
| `[IMG_V2] TX ACK` | 发送ACK响应 |
| `[IMG_V2] TX NAK` | 发送NAK响应（帧错误） |
| `[IMG_V2] ✅ Transfer COMPLETE` | 全部帧接收成功 |
| `[IMG_V2] ❌ Transfer FAILED` | 缺失帧或校验失败 |
| `[IMG_V2] ⏱ Timeout` | 等待超时 |

---

**下一步**: 按照上述步骤逐一检查，应该能找到问题所在！

