# 可靠图像传输协议 V2 - 完整设计文档

## 1. 协议概述

这是一个完全同步的帧-响应型可靠传输协议，确保每一页数据都被正确接收和存储后才能继续下一页传输。

## 2. 通信流程

```
上位机                          单片机
  |                              |
  |-- START 命令 -------->         |
  |                              |  准备接收
  |<--------- READY 响应 ---------|
  |                              |
  |-- 图像头帧 -------->          |
  |                              |  验证CRC/校验和
  |                              |  存储到Flash
  |<------ ACK/NACK ---------|
  |                              |
  |  (重复 61 次数据帧)           |
  |-- 数据帧[0] -------->         |
  |<------ ACK/NACK ---------|
  |-- 数据帧[1] -------->         |
  |<------ ACK/NACK ---------|
  |  ...                        |
  |-- 数据帧[60] -------->        |
  |<------ ACK/NACK ---------|
  |                              |
  |-- END 命令 -------->          |
  |                              |  校验所有帧是否完整
  |<----- COMPLETE/FAIL ------|  校验完整性并返回结果
  |                              |

```

## 3. 帧格式定义

### 3.1 控制帧 (START/END/READY/COMPLETE)

```
字节位置    内容                说明
------      ----                ----
0           0x55                帧头标志
1           命令                0x01=START, 0x02=END, 0x03=READY, 0x04=COMPLETE
2           校验和              前两字节的和 mod 256
3           0xAA                帧尾标志

总长度: 4 字节
```

### 3.2 数据帧 (图像头/图像数据)

```
字节位置    内容                  说明
------      ----                  ----
0           0x55                  帧头标志
1           帧类型                0x11=图像头, 0x10=图像数据
2-3         帧编号(LE)            0-60 for 图像数据, 0 for 图像头
4           Slot ID               0-7 (目标存储位置)
5-8         CRC32(LE)             Payload 的 CRC32
9-256       负载数据              248 字节
257         校验和                字节[0..256]的和 mod 256
258         0xAA                  帧尾标志

总长度: 259 字节
```

### 3.3 应答帧 (ACK/NAK)

```
字节位置    内容                说明
------      ----                ----
0           0x55                帧头标志
1           响应类型            0x20=ACK, 0x21=NAK
2-3         帧编号(LE)          对应的帧编号
4           校验和              前三字节的和 mod 256
5           0xAA                帧尾标志

总长度: 6 字节
```

## 4. 完整性校验

### 4.1 单帧校验
- **CRC32**: 对 248 字节负载数据计算，用于检测数据损伤
- **校验和**: 对整个帧（不含帧头/尾和校验和本身）计算，用于检测传输错误

### 4.2 全部帧校验
- 发送端: 在传输所有 61 帧后，发送一个最终完整性码
- 接收端: 在收到 END 命令前，验证所有 61 帧都已收到（帧位图）
- 完整性码: 所有已接收帧的 CRC32 组合检验

## 5. 状态机

### 5.1 上位机状态

```
IDLE --> START --> SEND_HEADER --> SEND_DATA --> SEND_END --> COMPLETE

超时或NAK时回退到 SEND_HEADER 或 SEND_DATA 并重试
```

### 5.2 单片机状态

```
IDLE --> READY --> WAITING_DATA --> VERIFY --> COMPLETE

接收START后进入READY
接收END后进入VERIFY（验证所有帧）
```

## 6. 超时和重试

### 6.1 超时设置
- **帧超时**: 3000ms
  - 发送每一帧后，上位机等待 ACK/NAK 响应
  - 如果超时，重试该帧
- **空闲超时**: 5000ms
  - 单片机检测到长时间无数据，重置状态机

### 6.2 重试次数
- **最大重试**: 5 次
- **策略**:
  - 前 3 次: 直接重试
  - 第 4-5 次: 延长等待时间后重试
  - 超过 5 次: 放弃，报告失败

## 7. 关键改进点

### 7.1 同步机制
- **问题**: 原协议上位机一直发送，不等待ACK
- **解决**: 上位机每发送一帧，必须等待单片机返回的 ACK/NAK
- **实现**: 使用事件驱动，在收到响应前不继续发送

### 7.2 单片机响应
- **关键**: Flash 写入完成后立即返回 ACK
- **验证**: 先验证CRC/校验和，然后写入Flash，最后发送ACK
- **错误**: 任何验证失败或写入失败立即返回NAK

### 7.3 完整性保证
- 每帧都有CRC32校验
- 接收端使用帧位图跟踪已接收的帧
- 传输完成后，验证是否接收到全部61帧
- 如果缺失帧，返回FAIL并告知缺失帧号

## 8. 命令码定义

```
控制帧:
0x01 = START        (上位机发)
0x02 = END          (上位机发)
0x03 = READY        (单片机发)
0x04 = COMPLETE     (单片机发)
0x05 = FAIL         (单片机发，完整性检查失败)

数据帧:
0x10 = IMAGE_DATA   (上位机发)
0x11 = IMAGE_HEADER (上位机发)

应答帧:
0x20 = ACK          (单片机发)
0x21 = NAK          (单片机发)
```

## 9. 实现检查清单

### 单片机端
- [ ] 接收START后发送READY
- [ ] 接收数据帧后验证CRC和校验和
- [ ] 验证通过立即返回ACK并写入Flash
- [ ] 验证失败返回NAK
- [ ] 跟踪已接收帧的位图
- [ ] 收到END后验证所有61帧是否完整
- [ ] 返回COMPLETE (成功) 或 FAIL (缺失帧)

### 上位机端
- [ ] 发送START后等待READY
- [ ] 发送每帧后等待ACK/NAK (3秒超时)
- [ ] 收到NAK后重试该帧 (最多5次)
- [ ] 所有61帧都ACK后，发送END
- [ ] 等待COMPLETE/FAIL响应 (5秒超时)
- [ ] 显示完整的传输统计

## 10. 调试信息输出

### 单片机
```
[IMG_V2] RX START
[IMG_V2] TX READY
[IMG_V2] RX HEADER: slot=0
[IMG_V2] TX ACK: frame=0 (Header)
[IMG_V2] RX DATA: frame=0, CRC=0xXXXXXXXX
[IMG_V2] Flash write OK: 248 bytes
[IMG_V2] TX ACK: frame=0
...
[IMG_V2] RX END
[IMG_V2] Verify: 61/61 frames received
[IMG_V2] TX COMPLETE
```

### 上位机
```
发送START
等待READY... 收到
发送图像头
等待ACK... 收到 (Frame 0)
发送数据帧 0/61
等待ACK... 收到
发送数据帧 1/61
等待ACK... 收到
...
发送数据帧 60/61
等待ACK... 收到
发送END
等待COMPLETE... 收到
传输成功! 61/61 帧已确认
```
