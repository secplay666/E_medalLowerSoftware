# 串口调试工具 V3 升级版 - 功能完全说明

## 📋 目录

1. [串口连接配置](#串口连接配置)
2. [图像处理功能](#图像处理功能)
3. [图像传输功能](#图像传输功能)
4. [高级设置](#高级设置)
5. [数据收发](#数据收发)
6. [日志和调试](#日志和调试)

---

## 🔌 串口连接配置

### 波特率 (Baud Rate)
支持的波特率范围：
- 低速: 300, 600, 1200, 2400, 4800, 9600
- 中速: 14400, 19200, 28800, 38400
- 高速: 57600, 115200, 230400, 460800, 921600

**推荐值:** 115200 (对应MCU新协议V2)

### 数据位 (Data Bits)
- 7 位
- **8 位** (推荐，默认选中)

### 校验位 (Parity)
- **无 (None)** - 默认，推荐
- 偶校验 (Even)
- 奇校验 (Odd)

### 停止位 (Stop Bits)
- **1 位** - 默认，推荐
- 2 位

### 流控 (RTS Control)
- **无** - 默认
- 硬件流控 - 某些MCU需要

### 连接状态指示
- 🟢 绿灯 + "在线" = 已连接
- 🔴 红灯 + "离线" = 未连接

---

## 🖼️ 图像处理功能

### 标签页 1: 图像处理

#### 图像选择和预览
1. 点击"选择图像"选择本地图像文件
2. 点击"预览"加载图像并显示原始效果

#### 画布展示
- **左侧画布**: 原始图像处理前
- **右侧画布**: 处理后的最终图像

#### 图像类型选择
- **黑白 (B&W)** - 仅输出黑白通道
- **红色 (Red)** - 仅输出红色通道
- **黑白+红色 (B&W+Red)** - 三色显示

#### 图像缩放设置

**缩放模式:**
- **适配 (Fit)** - 保持宽高比，缩放至合适大小
- **填充 (Fill)** - 保持宽高比，填充整个区域
- **拉伸 (Stretch)** - 直接拉伸至指定尺寸（可能变形）

**自定义尺寸:**
- 图像宽度: 默认400px (范围: 100-800px)
- 图像高度: 默认300px (范围: 100-800px)

#### 图像处理选项

**1. 二值化 (Binarization)** ✅ 默认启用
- 用途: 将彩色图转为黑白两色
- 阈值范围: 0-255 (默认128)
  - 像素值 > 阈值 → 白色 (255)
  - 像素值 ≤ 阈值 → 黑色 (0)
- 用于E-ink显示的最常用处理

**2. 线稿提取 (Line Extraction)**
- 用途: 提取图像边缘和轮廓
- 算法: Sobel边缘检测
- 适用: 图表、图纸、简笔画

**3. 启用剪裁 (Crop)**
- 用途: 裁剪图像的特定区域
- 参数:
  - X偏移: 裁剪起始X坐标
  - Y偏移: 裁剪起始Y坐标
  - 裁剪宽度: 裁剪区域宽度
  - 裁剪高度: 裁剪区域高度

**4. 反色 (Invert)**
- 用途: 反转图像颜色 (黑↔白)
- 适用: 某些特殊显示场景

**5. 抖动 (Dither)**
- 用途: 增加灰度层次感
- 算法: Floyd-Steinberg 抖动
- 适用: 需要更自然过渡的图像

#### 实时处理
- 修改任何参数后，"应用处理"按钮会自动被激活
- 点击"应用处理"或修改任何复选框立即查看效果

---

### 标签页 2: 图像传输

#### 传输参数

**目标Slot ID (0-7)**
- 指定图像存储在MCU的哪个槽位
- 范围: 0-7 (共8个槽位)
- 默认: 0

**传输超时 (毫秒)**
- 单帧传输的超时时间
- 范围: 1000-10000ms
- 默认: 3000ms
- 用于处理MCU响应延迟或通信故障

**最大重试次数**
- 单帧发送失败后的重试次数
- 范围: 1-10
- 默认: 5
- 超过此次数仍失败则放弃该帧

#### 传输控制

- **开始传输**: 开始发送已处理的图像
- **停止**: 中途停止传输
- **重置**: 清空进度条和统计信息

#### 进度显示
- 绿色进度条显示当前传输进度 (0-100%)
- 实时更新每帧发送情况

#### 传输统计信息
显示传输过程中的实时数据:
- **已发送帧数**: 当前发送到第几帧 (XX/61)
- **已确认帧数**: MCU确认接收的帧数
- **NAK计数**: 接收到的NAK (负确认) 计数
- **重试次数**: 发生重新发送的次数
- **传输时间**: 本次传输所用总时间 (秒)
- **传输速率**: 平均传输速率 (KB/s)

---

### 标签页 3: 高级设置

#### 日志显示选项

**显示时间戳** ✅ 默认启用
- 每条日志前显示时刻 [HH:MM:SS]

**显示发送数据** ❌ 默认关闭
- 显示所有发送到MCU的数据
- HEX格式: 55 01 56 AA
- 用于调试传输问题

**显示接收数据** ❌ 默认关闭
- 显示所有从MCU接收的数据
- 同样支持HEX和ASCII格式
- 注意: 可能产生大量日志

**调试模式** ❌ 默认关闭
- 启用详细的调试信息
- 显示更多内部处理细节

**自动滚动** ✅ 默认启用
- 日志自动滚动到最新

#### 日志级别 (Log Level)

控制日志详细程度 (从繁到简):

1. **详细 (Verbose)** - 显示所有消息
   - 包含: 详细调试信息、数据收发、状态转换
   - 用于: 深度调试

2. **调试 (Debug)** - 显示调试及以上
   - 包含: 调试消息、数据收发
   - 用于: 开发调试

3. **信息 (Info)** ⭐ 推荐
   - 包含: 信息、警告、错误
   - 用于: 正常使用、问题排查

4. **警告 (Warning)** - 仅显示警告和错误
   - 用于: 最小日志输出

5. **错误 (Error)** - 仅显示错误
   - 用于: 减少干扰

#### 显示模式 (Display Mode)

控制数据显示格式:

- **十六进制 (HEX)**: 55 01 56 AA
- **ASCII**: 文本形式显示
- **混合 (Mixed)**: 同时显示HEX和ASCII

---

## 📤 数据收发

### 数据发送面板

#### HEX格式发送
1. 输入HEX数据 (空格分隔): `55 01 56 AA`
2. 点击"发送HEX"
3. 数据直接发送到MCU

**常用命令:**
- START: `55 01 56 AA` (启动传输)
- END: `55 02 57 AA` (结束传输)

#### 文本格式发送
1. 输入文本内容
2. 点击"发送文本"
3. 文本被转换为字节后发送

### 数据接收面板

#### 实时接收显示
- 显示从MCU接收到的所有数据
- 字节计数: 显示接收总字节数

#### 接收数据管理
- **清空接收**: 清除所有接收数据
- **下载**: 将接收数据保存到本地文件

---

## 📋 日志和调试

### 调试日志面板

#### 日志输出
- 包含所有操作的详细记录
- 支持过滤 (根据日志级别)
- 行数计数器

#### 日志管理
- **清空**: 删除所有日志
- **下载**: 保存日志到本地文件 (log_[时间戳].txt)

#### 日志图标含义
- ❌ 错误
- ⚠️ 警告
- ✅ 成功
- 🐛 调试
- ℹ️ 信息

---

## 🎯 使用流程示例

### 完整传输流程

1. **连接串口**
   - 选择波特率 (115200)
   - 其他参数保持默认
   - 点击"连接"
   - 验证状态变为"在线"

2. **准备图像**
   - 选择本地图像文件
   - 点击"预览"加载
   - 调整处理参数:
     - 缩放模式: 适配
     - 二值化: 启用 (阈值128)
   - 点击"应用处理"查看效果

3. **配置传输**
   - 目标Slot ID: 0 (或自定义)
   - 传输超时: 3000ms
   - 最大重试: 5

4. **发送图像**
   - 点击"开始传输"
   - 观察进度条
   - 查看统计信息
   - 等待完成提示

5. **验证结果**
   - 检查日志中是否有错误
   - 查看传输时间和速率
   - 在MCU端验证显示效果

### 故障排查流程

1. **启用调试模式**
   - 勾选"调试模式"
   - 勾选"显示发送数据"
   - 勾选"显示接收数据"
   - 日志级别改为"详细"

2. **检查日志**
   - 查看数据收发是否正常
   - 记录NAK或超时信息
   - 检查CRC错误

3. **调整参数**
   - 增加传输超时时间
   - 减少波特率 (到57600或38400)
   - 增加最大重试次数

4. **导出日志**
   - 点击"下载"保存日志
   - 用于分析和问题报告

---

## 💡 技巧和建议

### 图像处理最佳实践

1. **文档扫描**
   - 启用: 二值化 (阈值120-140)
   - 启用: 线稿提取 (可选)
   - 缩放: 适配

2. **彩色照片**
   - 启用: 二值化 (阈值100-150)
   - 启用: 抖动 (增加灰度)
   - 关闭: 线稿提取

3. **手绘图**
   - 启用: 二值化 (阈值80-120)
   - 启用: 线稿提取
   - 可选: 反色

### 传输优化

- 波特率: 优先使用115200
- 如频繁失败: 降至57600
- 重试次数: 根据环境质量设置 (3-5通常足够)
- 超时时间: 保持在3000-5000ms

### 调试建议

- 首次使用: 保持日志级别为"信息"
- 问题诊断: 改为"详细"并启用数据显示
- 批量传输: 改为"警告"或"错误"减少开销

---

## ⚙️ 新增功能对比

| 功能 | V2 版 | V3 升级版 |
|------|------|---------|
| 波特率 | 仅115200 | 15种可选 |
| 数据位 | 固定8 | 7/8可选 |
| 校验位 | 无 | 无/偶/奇 |
| 停止位 | 固定1 | 1/2可选 |
| 流控 | 无 | 支持硬件流控 |
| 图像类型 | B&W | B&W/Red/B&W+Red |
| 缩放模式 | 固定适配 | 适配/填充/拉伸 |
| 线稿提取 | ❌ | ✅ |
| 剪裁 | ❌ | ✅ |
| 反色 | ❌ | ✅ |
| 抖动 | ❌ | ✅ |
| 数据收发面板 | ❌ | ✅ |
| 接收数据显示 | ❌ | ✅ |
| 传输统计 | 基础 | 详细 (6项) |
| 显示模式 | 仅日志 | HEX/ASCII/混合 |
| 日志级别 | ❌ | ✅ 5个级别 |
| 时间戳 | 基础 | ✅ 可控 |
| 调试模式 | ❌ | ✅ |

---

## 🔧 常见问题

**Q: 为什么传输一直失败?**
A: 依次尝试:
1. 检查MCU是否已上传新固件
2. 验证波特率是否为115200
3. 将超时时间增加到5000ms
4. 将波特率降至57600试试
5. 启用调试模式查看具体错误

**Q: 图像显示不对**
A:
1. 检查二值化阈值 (尝试100-150)
2. 启用/关闭线稿提取试试
3. 尝试反色选项
4. 检查缩放模式设置

**Q: 如何导出配置?**
A: 点击"下载"按钮可以导出:
- 接收的数据文件
- 调试日志

**Q: 支持批量传输多张图片吗?**
A: 暂不支持，需手动逐张操作

---

## 📞 技术支持

如遇到问题，请：
1. 启用调试模式并记录日志
2. 下载日志文件
3. 附上日志信息报告问题

---

**最后更新:** 2025-10-22
**版本:** V3 升级版 (新协议V2)
**兼容MCU:** HC32L110C6UA + 新协议V2固件
