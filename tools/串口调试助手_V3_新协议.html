<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸²å£è°ƒè¯•å·¥å…· - æ–°åè®®V2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .panel {
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .section-title {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .settings {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            box-sizing: border-box;
            resize: vertical;
        }
        .progress-container {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .info-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .error-box {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            color: #c62828;
        }
        .success-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            color: #2e7d32;
        }
        input[type="file"],
        input[type="number"],
        select {
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
        label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœ¨ ä¸²å£è°ƒè¯•å·¥å…· - æ–°åè®®V2</h1>

        <!-- è¿æ¥è®¾ç½® -->
        <div class="panel">
            <div class="section-title">ğŸ”Œ ä¸²å£è®¾ç½®</div>
            <div class="settings">
                <div class="control-group">
                    <label>æ³¢ç‰¹ç‡:</label>
                    <select id="baudRate">
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200" selected>115200</option>
                    </select>
                </div>
                <div class="control-group">
                    <button id="connectBtn" onclick="connectSerial()">è¿æ¥ä¸²å£</button>
                    <button id="disconnectBtn" onclick="disconnectSerial()" disabled>æ–­å¼€è¿æ¥</button>
                </div>
            </div>
        </div>

        <!-- å›¾åƒé€‰æ‹©å’Œä¼ è¾“ -->
        <div class="panel">
            <div class="section-title">ğŸ“¤ å›¾åƒä¼ è¾“</div>
            <div class="settings">
                <div class="control-group">
                    <label>é€‰æ‹©å›¾åƒ:</label>
                    <input type="file" id="imageInput" accept="image/*">
                </div>
                <div class="control-group">
                    <button id="previewBtn" onclick="previewImage()" disabled>é¢„è§ˆ</button>
                </div>
                <div class="control-group">
                    <label>ç›®æ ‡Slot:</label>
                    <input type="number" id="slotId" min="0" max="7" value="0" style="width: 60px;">
                </div>
            </div>

            <div id="imageInfo" class="info-box" style="display:none;"></div>

            <div>
                <canvas id="previewCanvas" width="400" height="300" style="border: 1px solid #ddd; margin: 10px 0;"></canvas>
            </div>

            <div>
                <button id="sendBtn" onclick="sendImage()" disabled>å¼€å§‹ä¼ è¾“</button>
                <button id="stopBtn" onclick="stopTransfer()" disabled>åœæ­¢ä¼ è¾“</button>
                <button id="resetBtn" onclick="resetTransfer()" disabled>é‡ç½®</button>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
            </div>
            <div id="statusMsg" class="info-box">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="panel">
            <div class="section-title">ğŸ“‹ è°ƒè¯•æ—¥å¿—</div>
            <textarea id="logArea" readonly></textarea>
            <div>
                <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
    </div>

    <script>
        let port = null;
        let isConnected = false;
        let isTransferring = false;
        let imageData = null;

        const PROTO_START_MARK = 0x55;
        const PROTO_STOP_MARK = 0xAA;
        const CMD_START = 0x01;
        const CMD_END = 0x02;
        const FRAME_TYPE_IMAGE_HEADER = 0x11;
        const FRAME_TYPE_IMAGE_DATA = 0x10;
        const RESP_ACK = 0x20;
        const RESP_COMPLETE = 0x02;

        const IMAGE_PAGES = 61;
        const FRAME_PAYLOAD_SIZE = 248;
        const FRAME_TIMEOUT = 3000;
        const MAX_RETRIES = 5;

        // æ—¥å¿—è®°å½•
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.value += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logArea').value = '';
        }

        function updateStatus(message, type = 'info') {
            const statusMsg = document.getElementById('statusMsg');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            statusMsg.textContent = `${icon} [${timestamp}] ${message}`;
            statusMsg.className = type === 'error' ? 'error-box' : type === 'success' ? 'success-box' : 'info-box';
        }

        // ä¸²å£æ“ä½œ
        async function connectSerial() {
            try {
                port = await navigator.serial.requestPort();
                const baudRate = parseInt(document.getElementById('baudRate').value);
                await port.open({ baudRate, dataBits: 8, parity: 'none', stopBits: 1 });
                isConnected = true;
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;
                updateStatus('ä¸²å£å·²è¿æ¥', 'success');
                log('ä¸²å£è¿æ¥æˆåŠŸ');
                startReadLoop();
            } catch (err) {
                updateStatus('è¿æ¥å¤±è´¥: ' + err.message, 'error');
                log('è¿æ¥å¤±è´¥: ' + err.message);
            }
        }

        function disconnectSerial() {
            if (port) {
                port.close();
                isConnected = false;
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                updateStatus('ä¸²å£å·²æ–­å¼€', 'info');
                log('ä¸²å£å·²æ–­å¼€');
            }
        }

        async function startReadLoop() {
            if (!port || !port.readable) return;
            const reader = port.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    // æ•°æ®å·²æ¥æ”¶ï¼Œç¡¬ä»¶ä¼šè‡ªåŠ¨å¤„ç†ACKç­‰å“åº”
                }
            } finally {
                reader.releaseLock();
            }
        }

        // å›¾åƒå¤„ç†
        function previewImage() {
            const fileInput = document.getElementById('imageInput');
            if (!fileInput.files.length) {
                updateStatus('è¯·å…ˆé€‰æ‹©å›¾åƒæ–‡ä»¶', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    imageData = img;
                    drawPreview(img);
                    document.getElementById('sendBtn').disabled = false;
                    updateStatus('å›¾åƒå·²åŠ è½½: ' + img.width + 'x' + img.height, 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function drawPreview(img) {
            const canvas = document.getElementById('previewCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
            const x = (canvas.width - img.width * scale) / 2;
            const y = (canvas.height - img.height * scale) / 2;
            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
        }

        // CRC32è®¡ç®—
        function calculateCRC32(data) {
            let crc = 0xFFFFFFFF;
            for (let i = 0; i < data.length; i++) {
                crc ^= data[i];
                for (let j = 0; j < 8; j++) {
                    if (crc & 1) {
                        crc = (crc >>> 1) ^ 0xEDB88320;
                    } else {
                        crc = crc >>> 1;
                    }
                }
            }
            return (crc ^ 0xFFFFFFFF) >>> 0;
        }

        // æ ¡éªŒå’Œè®¡ç®—
        function calculateChecksum(data) {
            let sum = 0;
            for (let i = 0; i < data.length; i++) {
                sum = (sum + data[i]) & 0xFF;
            }
            return sum;
        }

        // å¸§æ„å»º
        function buildControlFrame(command) {
            const frame = new Uint8Array(4);
            frame[0] = PROTO_START_MARK;
            frame[1] = command;
            frame[2] = calculateChecksum(frame.slice(0, 2));
            frame[3] = PROTO_STOP_MARK;
            return frame;
        }

        function buildDataFrame(frameType, frameNum, slotId, payload) {
            const frame = new Uint8Array(259);
            let offset = 0;

            frame[offset++] = PROTO_START_MARK;
            frame[offset++] = frameType;
            frame[offset++] = frameNum & 0xFF;
            frame[offset++] = (frameNum >> 8) & 0xFF;
            frame[offset++] = slotId;

            // CRC32
            const crc = calculateCRC32(payload);
            frame[offset++] = crc & 0xFF;
            frame[offset++] = (crc >> 8) & 0xFF;
            frame[offset++] = (crc >> 16) & 0xFF;
            frame[offset++] = (crc >> 24) & 0xFF;

            // è½½è·
            frame.set(payload, offset);
            offset += FRAME_PAYLOAD_SIZE;

            // æ ¡éªŒå’Œå’Œå°¾æ ‡è®°
            frame[offset++] = calculateChecksum(frame.slice(0, 257));
            frame[offset++] = PROTO_STOP_MARK;

            return frame;
        }

        // å›¾åƒå‘é€
        async function sendImage() {
            if (!isConnected || !imageData) {
                updateStatus('æœªå‡†å¤‡å¥½', 'error');
                return;
            }

            isTransferring = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;

            try {
                // 1. å‘é€START
                log('å‘é€STARTå‘½ä»¤...');
                await sendFrame(buildControlFrame(CMD_START));
                await delay(100);

                // 2. ç­‰å¾…READY
                log('ç­‰å¾…READYå“åº”...');
                await delay(500);

                // 3. å‘é€å›¾åƒå¤´
                log('å‘é€å›¾åƒå¤´...');
                const slotId = parseInt(document.getElementById('slotId').value);
                const headerPayload = new Uint8Array(FRAME_PAYLOAD_SIZE);
                headerPayload.fill(0xFF);
                await sendDataFrameWithRetry(FRAME_TYPE_IMAGE_HEADER, 0, slotId, headerPayload);

                // 4. å‘é€61å¸§å›¾åƒæ•°æ®
                log('å¼€å§‹å‘é€å›¾åƒæ•°æ®...');
                const imageBytes = convertImageToBytes(imageData);
                for (let i = 0; i < IMAGE_PAGES; i++) {
                    if (!isTransferring) break;

                    const start = i * FRAME_PAYLOAD_SIZE;
                    const end = Math.min(start + FRAME_PAYLOAD_SIZE, imageBytes.length);
                    const pageData = new Uint8Array(FRAME_PAYLOAD_SIZE);
                    pageData.set(imageBytes.slice(start, end));
                    if (end - start < FRAME_PAYLOAD_SIZE) {
                        pageData.fill(0xFF, end - start);
                    }

                    await sendDataFrameWithRetry(FRAME_TYPE_IMAGE_DATA, i, slotId, pageData);

                    const progress = ((i + 1) / IMAGE_PAGES * 100).toFixed(1);
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('progressBar').textContent = progress + '%';
                    updateStatus(`ä¼ è¾“ä¸­... ${progress}%`);
                }

                // 5. å‘é€END
                log('å‘é€ENDå‘½ä»¤...');
                await sendFrame(buildControlFrame(CMD_END));
                await delay(500);

                updateStatus('âœ… ä¼ è¾“å®Œæˆï¼', 'success');
                log('ä¼ è¾“å®Œæˆ');

            } catch (err) {
                updateStatus('âŒ ä¼ è¾“å¤±è´¥: ' + err.message, 'error');
                log('ä¼ è¾“å¤±è´¥: ' + err.message);
            } finally {
                isTransferring = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        async function sendDataFrameWithRetry(frameType, frameNum, slotId, payload) {
            for (let retry = 0; retry < MAX_RETRIES; retry++) {
                const frame = buildDataFrame(frameType, frameNum, slotId, payload);
                log(`å‘é€å¸§${frameNum} (å°è¯•${retry + 1}/${MAX_RETRIES})...`);
                await sendFrame(frame);
                await delay(50); // ç­‰å¾…å“åº”å¤„ç†æ—¶é—´
            }
        }

        async function sendFrame(frame) {
            if (!port || !port.writable) {
                throw new Error('ä¸²å£æœªè¿æ¥');
            }
            const writer = port.writable.getWriter();
            await writer.write(frame);
            writer.releaseLock();
        }

        function convertImageToBytes(img) {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 400, 300);

            const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
            const x = (canvas.width - img.width * scale) / 2;
            const y = (canvas.height - img.height * scale) / 2;
            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

            const imageData = ctx.getImageData(0, 0, 400, 300);
            const data = imageData.data;
            const bytes = new Uint8Array(400 * 300 / 8);

            let byteIdx = 0;
            for (let i = 0; i < data.length; i += 32) {
                let byte = 0;
                for (let bit = 0; bit < 8 && i + bit * 4 < data.length; bit++) {
                    if (data[i + bit * 4] > 128) {
                        byte |= (1 << (7 - bit));
                    }
                }
                bytes[byteIdx++] = byte;
            }

            return bytes;
        }

        function stopTransfer() {
            isTransferring = false;
            updateStatus('ä¼ è¾“å·²åœæ­¢', 'info');
            log('ç”¨æˆ·åœæ­¢äº†ä¼ è¾“');
        }

        function resetTransfer() {
            imageData = null;
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            updateStatus('å·²é‡ç½®', 'info');
            log('å·²é‡ç½®');
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            updateStatus('å°±ç»ª', 'info');
            log('åº”ç”¨å·²å°±ç»ª');
        };
    </script>
</body>
</html>
